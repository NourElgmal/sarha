const joi = require('joi');

const schemas = {
  body: joi.object({
    name: joi.string().required().min(3).max(15),
    email: joi.string().required().email(),
    pass: joi.string().required().pattern(/^[a-zA-Z0-9]{3,30}$/),
    refpass: joi.string().valid(joi.ref('pass')),
    age: joi.number().required().min(11).max(80)
  }),
  params: joi.object({
    id: joi.string().min(4)
  })
};

module.exports.validate = (req, res, next) => {
  let arrerr = [];
  const keysToValidate = ["body", "params"];
  
  keysToValidate.forEach((key) => {
    const { error } = schemas[key].validate(req[key], { abortEarly: false, allowUnknown: true });
    if (error) {
      error.details.forEach((err) => {
        arrerr.push({ msg: err.message });
      });
    }
  });

  if (arrerr.length > 0) {
    res.status(400).json({ "msg": arrerr });
  } else {
    next();
  }
};
